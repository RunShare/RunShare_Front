<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ëŸ¬ë‹ ì½”ìŠ¤ ì•± - í”„ë¡ íŠ¸ì—”ë“œ ì „ìš©</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: 'Arial', sans-serif; background: #f5f7fa; }
        
        /* í—¤ë” ë° ë„¤ë¹„ê²Œì´ì…˜ */
        .header { background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; padding: 15px 0; box-shadow: 0 2px 10px rgba(0,0,0,0.1); }
        .header-content { max-width: 1200px; margin: 0 auto; display: flex; justify-content: space-between; align-items: center; padding: 0 20px; }
        .logo { font-size: 24px; font-weight: bold; }
        .user-info { display: flex; align-items: center; gap: 15px; }
        .user-info span { font-size: 14px; }
        .btn { padding: 8px 16px; border: none; border-radius: 6px; cursor: pointer; font-weight: 500; transition: all 0.3s; }
        .btn-primary { background: #4285f4; color: white; }
        .btn-primary:hover { background: #3367d6; }
        .btn-secondary { background: white; color: #667eea; }
        .btn-secondary:hover { background: #f8f9fa; }
        .btn-danger { background: #ea4335; color: white; }
        .btn-danger:hover { background: #d33b2c; }
        .btn-success { background: #34a853; color: white; }
        .btn-success:hover { background: #2d7a40; }
        
        /* ë„¤ë¹„ê²Œì´ì…˜ ë©”ë‰´ */
        .nav-menu { background: white; border-bottom: 1px solid #e9ecef; }
        .nav-content { max-width: 1200px; margin: 0 auto; display: flex; gap: 0; }
        .nav-item { padding: 15px 20px; cursor: pointer; border-bottom: 3px solid transparent; transition: all 0.3s; }
        .nav-item:hover { background: #f8f9fa; }
        .nav-item.active { border-bottom-color: #4285f4; background: #e3f2fd; color: #1976d2; }
        
        /* ë©”ì¸ ì»¨í…Œì´ë„ˆ */
        .container { max-width: 1200px; margin: 0 auto; padding: 20px; }
        .screen { display: none; animation: fadeIn 0.3s ease-in; }
        .screen.active { display: block; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        
        /* í¼ ìŠ¤íƒ€ì¼ */
        .form-container { max-width: 400px; margin: 50px auto; background: white; padding: 40px; border-radius: 12px; box-shadow: 0 4px 20px rgba(0,0,0,0.1); }
        .form-group { margin-bottom: 20px; }
        .form-group label { display: block; margin-bottom: 5px; font-weight: 500; color: #333; }
        .form-control { width: 100%; padding: 12px; border: 1px solid #ddd; border-radius: 6px; font-size: 14px; }
        .form-control:focus { outline: none; border-color: #4285f4; box-shadow: 0 0 0 2px rgba(66, 133, 244, 0.2); }
        
        /* ì¹´ë“œ ìŠ¤íƒ€ì¼ */
        .card { background: white; border-radius: 12px; padding: 20px; margin-bottom: 20px; box-shadow: 0 2px 10px rgba(0,0,0,0.1); }
        .card h3 { color: #333; margin-bottom: 15px; }
        
        /* ì§€ë„ ìŠ¤íƒ€ì¼ */
        #map { height: 500px; width: 100%; border-radius: 8px; box-shadow: 0 4px 15px rgba(0,0,0,0.1); }
        
        /* ì»¨íŠ¸ë¡¤ íŒ¨ë„ */
        .controls { background: white; padding: 20px; border-radius: 8px; margin-bottom: 20px; box-shadow: 0 2px 10px rgba(0,0,0,0.1); }
        .controls .row { display: flex; gap: 10px; align-items: center; flex-wrap: wrap; margin-bottom: 10px; }
        .controls .row:last-child { margin-bottom: 0; }
        
        /* ì½”ìŠ¤ ëª©ë¡ */
        .course-list { display: grid; grid-template-columns: repeat(auto-fill, minmax(350px, 1fr)); gap: 20px; }
        .course-item { background: white; border-radius: 12px; padding: 20px; box-shadow: 0 2px 10px rgba(0,0,0,0.1); transition: transform 0.2s; }
        .course-item:hover { transform: translateY(-2px); box-shadow: 0 4px 20px rgba(0,0,0,0.15); }
        .course-header { display: flex; justify-content: space-between; align-items: start; margin-bottom: 10px; }
        .course-title { font-size: 18px; font-weight: bold; color: #333; }
        .difficulty-badge { padding: 4px 8px; border-radius: 4px; font-size: 12px; font-weight: bold; }
        .difficulty-1 { background: #e8f5e8; color: #2e7d32; }
        .difficulty-2 { background: #fff3e0; color: #f57c00; }
        .difficulty-3 { background: #fff8e1; color: #f9a825; }
        .difficulty-4 { background: #fce4ec; color: #c2185b; }
        .difficulty-5 { background: #ffebee; color: #d32f2f; }
        .course-info { color: #666; font-size: 14px; margin-bottom: 15px; }
        .course-actions { display: flex; gap: 8px; flex-wrap: wrap; }
        
        /* ê²€ìƒ‰ í•„í„° */
        .search-filters { background: white; padding: 20px; border-radius: 8px; margin-bottom: 20px; }
        .filter-row { display: flex; gap: 15px; align-items: center; margin-bottom: 15px; flex-wrap: wrap; }
        .filter-row:last-child { margin-bottom: 0; }
        
        /* í†µê³„ í‘œì‹œ */
        .stats { background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; padding: 20px; border-radius: 8px; margin-bottom: 20px; text-align: center; }
        .stats h2 { margin-bottom: 10px; }
        
        /* ë¡œë”© */
        .loading { text-align: center; padding: 40px; color: #666; }
        .loading::after { content: 'âŸ³'; display: inline-block; animation: spin 1s linear infinite; margin-left: 10px; }
        @keyframes spin { from { transform: rotate(0deg); } to { transform: rotate(360deg); } }
        
        /* ì•Œë¦¼ */
        .alert { padding: 12px 16px; border-radius: 6px; margin-bottom: 15px; }
        .alert-success { background: #d4edda; color: #155724; border: 1px solid #c3e6cb; }
        .alert-error { background: #f8d7da; color: #721c24; border: 1px solid #f5c6cb; }
        .alert-warning { background: #fff3cd; color: #856404; border: 1px solid #ffeaa7; }
        
        /* ì¸í¬ë°•ìŠ¤ */
        .info-box { background: #e3f2fd; border: 1px solid #2196f3; padding: 15px; border-radius: 8px; margin-bottom: 20px; }
        .info-box h4 { color: #1976d2; margin-bottom: 10px; }
        
        /* ë°˜ì‘í˜• */
        @media (max-width: 768px) {
            .header-content { flex-direction: column; gap: 10px; }
            .nav-content { flex-wrap: wrap; }
            .controls .row { flex-direction: column; align-items: stretch; }
            .course-list { grid-template-columns: 1fr; }
            .filter-row { flex-direction: column; align-items: stretch; }
        }
    </style>
</head>
<body>
    <!-- í—¤ë” -->
    <header class="header">
        <div class="header-content">
            <div class="logo">ğŸƒâ€â™‚ï¸ ëŸ¬ë‹ ì½”ìŠ¤ ì•±</div>
            <div class="user-info" id="userInfo">
                <span id="userDisplay">ë¡œê·¸ì¸ì´ í•„ìš”í•©ë‹ˆë‹¤</span>
                <button class="btn btn-secondary" id="authBtn" onclick="showLogin()">ë¡œê·¸ì¸</button>
            </div>
        </div>
    </header>
    
    <!-- ë„¤ë¹„ê²Œì´ì…˜ (ë¡œê·¸ì¸ í›„ í‘œì‹œ) -->
    <nav class="nav-menu" id="navMenu" style="display: none;">
        <div class="nav-content">
            <div class="nav-item" onclick="showScreen('draw')">ğŸ—ºï¸ ì½”ìŠ¤ ê·¸ë¦¬ê¸°</div>
            <div class="nav-item" onclick="showScreen('myCourses')">ğŸ“‹ ë‚´ ì½”ìŠ¤</div>
            <div class="nav-item" onclick="showScreen('search')">ğŸ” ì½”ìŠ¤ ê²€ìƒ‰</div>
            <div class="nav-item" onclick="showScreen('gpxDownload')">ğŸ“ GPX ê´€ë¦¬</div>
        </div>
    </nav>
    
    <div class="container">
        <!-- ë©”ì¸ í™”ë©´ (ë¡œê·¸ì¸/íšŒì›ê°€ì…) -->
        <div id="loginScreen" class="screen active">
            <div class="info-box">
                <h4>ğŸ‰ í”„ë¡ íŠ¸ì—”ë“œ ì „ìš© ë²„ì „</h4>
                <p>ì„œë²„ ì—†ì´ ë¸Œë¼ìš°ì € ë¡œì»¬ ì €ì¥ì†Œë§Œ ì‚¬ìš©í•©ë‹ˆë‹¤. ëª¨ë“  ë°ì´í„°ëŠ” ë¸Œë¼ìš°ì €ì— ì €ì¥ë˜ë©°, ë‹¤ë¥¸ ê¸°ê¸°ì—ì„œëŠ” ì ‘ê·¼í•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤.</p>
                <p><strong>âš¡ ì¦‰ì‹œ ì‚¬ìš© ê°€ëŠ¥!</strong> ì„¤ì¹˜ë‚˜ ì„œë²„ ì„¤ì •ì´ í•„ìš” ì—†ìŠµë‹ˆë‹¤.</p>
            </div>
            
            <div class="form-container">
                <h2 style="text-align: center; margin-bottom: 30px; color: #333;">ë¡œê·¸ì¸</h2>
                <div id="loginAlert"></div>
                <form id="loginForm">
                    <div class="form-group">
                        <label>ì‚¬ìš©ìëª…</label>
                        <input type="text" class="form-control" id="loginUsername" required>
                    </div>
                    <div class="form-group">
                        <label>ë¹„ë°€ë²ˆí˜¸</label>
                        <input type="password" class="form-control" id="loginPassword" required>
                    </div>
                    <button type="submit" class="btn btn-primary" style="width: 100%; margin-bottom: 15px;">ë¡œê·¸ì¸</button>
                </form>
                <div style="text-align: center;">
                    <span>ê³„ì •ì´ ì—†ìœ¼ì‹ ê°€ìš”? </span>
                    <a href="#" onclick="showRegister()" style="color: #4285f4; text-decoration: none;">íšŒì›ê°€ì…</a>
                </div>
                
                <!-- ë°ëª¨ ê³„ì • -->
                <div style="margin-top: 20px; padding: 15px; background: #f8f9fa; border-radius: 8px; text-align: center;">
                    <h4 style="margin-bottom: 10px;">ğŸ¯ ë¹ ë¥¸ í…ŒìŠ¤íŠ¸</h4>
                    <button class="btn btn-success" onclick="createDemoAccount()">ë°ëª¨ ê³„ì • ìƒì„± & ë¡œê·¸ì¸</button>
                    <p style="margin-top: 10px; font-size: 12px; color: #666;">
                        ìƒ˜í”Œ ì‚¬ìš©ìì™€ ì½”ìŠ¤ ë°ì´í„°ë¥¼ ìë™ìœ¼ë¡œ ìƒì„±í•©ë‹ˆë‹¤
                    </p>
                </div>
            </div>
        </div>
        
        <!-- íšŒì›ê°€ì… í™”ë©´ -->
        <div id="registerScreen" class="screen">
            <div class="form-container">
                <h2 style="text-align: center; margin-bottom: 30px; color: #333;">íšŒì›ê°€ì…</h2>
                <div id="registerAlert"></div>
                <form id="registerForm">
                    <div class="form-group">
                        <label>ì‚¬ìš©ìëª…</label>
                        <input type="text" class="form-control" id="regUsername" required>
                    </div>
                    <div class="form-group">
                        <label>ë¹„ë°€ë²ˆí˜¸</label>
                        <input type="password" class="form-control" id="regPassword" required>
                    </div>
                    <div class="form-group">
                        <label>ì´ë©”ì¼</label>
                        <input type="email" class="form-control" id="regEmail" required>
                    </div>
                    <div class="form-group">
                        <label>ë‹‰ë„¤ì„</label>
                        <input type="text" class="form-control" id="regNickname" required>
                    </div>
                    <button type="submit" class="btn btn-primary" style="width: 100%; margin-bottom: 15px;">íšŒì›ê°€ì…</button>
                </form>
                <div style="text-align: center;">
                    <span>ì´ë¯¸ ê³„ì •ì´ ìˆìœ¼ì‹ ê°€ìš”? </span>
                    <a href="#" onclick="showLogin()" style="color: #4285f4; text-decoration: none;">ë¡œê·¸ì¸</a>
                </div>
            </div>
        </div>
        
        <!-- ì½”ìŠ¤ ê·¸ë¦¬ê¸° í™”ë©´ -->
        <div id="drawScreen" class="screen">
            <div class="card">
                <h3>ğŸ—ºï¸ ìƒˆ ì½”ìŠ¤ ê·¸ë¦¬ê¸°</h3>
                <div class="controls">
                    <div class="row">
                        <button id="drawModeBtn" class="btn btn-primary" onclick="setDrawMode(true)">âœï¸ ê·¸ë¦¬ê¸° ëª¨ë“œ</button>
                        <button id="viewModeBtn" class="btn btn-secondary" onclick="setDrawMode(false)">ğŸ‘ï¸ ë³´ê¸° ëª¨ë“œ</button>
                        <button class="btn btn-secondary" onclick="getCurrentLocation()">ğŸ“ ë‚´ ìœ„ì¹˜ë¡œ</button>
                        <button class="btn btn-danger" onclick="clearPath()">ğŸ—‘ï¸ ê²½ë¡œ ì§€ìš°ê¸°</button>
                        <button class="btn btn-secondary" onclick="undoLastPoint()">â†¶ ë˜ëŒë¦¬ê¸°</button>
                    </div>
                    <div class="row">
                        <input type="text" class="form-control" id="courseName" placeholder="ì½”ìŠ¤ ì´ë¦„" style="flex: 1;">
                        <input type="text" class="form-control" id="courseDescription" placeholder="ì½”ìŠ¤ ì„¤ëª… (ì„ íƒì‚¬í•­)" style="flex: 2;">
                        <select class="form-control" id="courseDifficulty">
                            <option value="1">ì‰¬ì›€</option>
                            <option value="2">ë³´í†µ</option>
                            <option value="3" selected>ì¤‘ê°„</option>
                            <option value="4">ì–´ë ¤ì›€</option>
                            <option value="5">ë§¤ìš° ì–´ë ¤ì›€</option>
                        </select>
                        <label><input type="checkbox" id="coursePublic" checked> ê³µê°œ</label>
                        <button class="btn btn-primary" onclick="saveCourse()">ğŸ’¾ ì €ì¥</button>
                    </div>
                </div>
                <div class="stats" id="drawStats">ì§€ë„ë¥¼ í´ë¦­í•´ì„œ ê²½ë¡œë¥¼ ê·¸ë ¤ë³´ì„¸ìš”! ğŸ—ºï¸</div>
                <div id="map"></div>
            </div>
        </div>
        
        <!-- ë‚´ ì½”ìŠ¤ í™”ë©´ -->
        <div id="myCoursesScreen" class="screen">
            <div class="card">
                <h3>ğŸ“‹ ë‚´ ì½”ìŠ¤ ëª©ë¡</h3>
                <div class="controls">
                    <div class="row">
                        <label>ì •ë ¬:</label>
                        <select class="form-control" id="mySortBy" onchange="loadMyCourses()" style="width: 150px;">
                            <option value="date">ìµœì‹ ìˆœ</option>
                            <option value="distance">ê±°ë¦¬ìˆœ</option>
                            <option value="difficulty">ë‚œì´ë„ìˆœ</option>
                            <option value="name">ì´ë¦„ìˆœ</option>
                        </select>
                        <button class="btn btn-primary" onclick="loadMyCourses()">ğŸ”„ ìƒˆë¡œê³ ì¹¨</button>
                        <span style="margin-left: auto; color: #666;" id="myCoursesCount"></span>
                    </div>
                </div>
                <div id="myCoursesContent">
                    <div class="loading">ë‚´ ì½”ìŠ¤ë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘...</div>
                </div>
            </div>
        </div>
        
        <!-- ì½”ìŠ¤ ê²€ìƒ‰ í™”ë©´ -->
        <div id="searchScreen" class="screen">
            <div class="card">
                <h3>ğŸ” ê³µê°œ ì½”ìŠ¤ ê²€ìƒ‰</h3>
                <div class="search-filters">
                    <div class="filter-row">
                        <label>ë‚œì´ë„:</label>
                        <select class="form-control" id="searchDifficulty" style="width: 120px;">
                            <option value="">ì „ì²´</option>
                            <option value="1">ì‰¬ì›€</option>
                            <option value="2">ë³´í†µ</option>
                            <option value="3">ì¤‘ê°„</option>
                            <option value="4">ì–´ë ¤ì›€</option>
                            <option value="5">ë§¤ìš° ì–´ë ¤ì›€</option>
                        </select>
                        
                        <label>ê±°ë¦¬ (km):</label>
                        <input type="number" class="form-control" id="searchMinDistance" placeholder="ìµœì†Œ" style="width: 80px;" min="0" step="0.1">
                        <span>~</span>
                        <input type="number" class="form-control" id="searchMaxDistance" placeholder="ìµœëŒ€" style="width: 80px;" min="0" step="0.1">
                        
                        <button class="btn btn-primary" onclick="searchCourses()">ğŸ” ê²€ìƒ‰</button>
                    </div>
                    <div class="filter-row">
                        <label>ë‚´ ìœ„ì¹˜ ê·¼ì²˜ (ë°˜ê²½ km):</label>
                        <input type="number" class="form-control" id="searchRadius" placeholder="10" value="10" style="width: 80px;" min="1" max="100">
                        <button class="btn btn-secondary" onclick="searchNearby()">ğŸ“ ë‚´ ìœ„ì¹˜ ê¸°ì¤€ ê²€ìƒ‰</button>
                        <span style="margin-left: auto; color: #666;" id="searchResultsCount"></span>
                    </div>
                </div>
                <div id="searchResults">
                    <p style="text-align: center; color: #666; padding: 40px;">ê²€ìƒ‰ ì¡°ê±´ì„ ì„¤ì •í•˜ê³  ê²€ìƒ‰ ë²„íŠ¼ì„ ëˆŒëŸ¬ì£¼ì„¸ìš”.</p>
                </div>
            </div>
        </div>
        
        <!-- ì½”ìŠ¤ ìƒì„¸ í™”ë©´ -->
        <div id="detailScreen" class="screen">
            <div class="card">
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                    <h3 id="detailTitle">ì½”ìŠ¤ ìƒì„¸ ì •ë³´</h3>
                    <button class="btn btn-secondary" onclick="goBack()">â† ë’¤ë¡œê°€ê¸°</button>
                </div>
                <div id="detailInfo"></div>
                <div id="detailMap" style="height: 400px; border-radius: 8px; margin-top: 20px;"></div>
            </div>
        </div>
        
        <!-- GPX ë‹¤ìš´ë¡œë“œ í™”ë©´ -->
        <div id="gpxDownloadScreen" class="screen">
            <div class="card">
                <h3>ğŸ“ GPX íŒŒì¼ ê´€ë¦¬</h3>
                <div class="info-box">
                    <h4>GPX íŒŒì¼ì´ë€?</h4>
                    <p>GPS ë°ì´í„°ë¥¼ í‘œì¤€ í˜•ì‹ìœ¼ë¡œ ì €ì¥í•œ íŒŒì¼ì…ë‹ˆë‹¤. Strava, Nike Run Club, ê°€ë¯¼ ë“±ì˜ ëŸ¬ë‹ ì•±ì—ì„œ ê°€ì ¸ì™€ì„œ ì‚¬ìš©í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.</p>
                </div>
                <div class="controls">
                    <div class="row">
                        <button class="btn btn-primary" onclick="loadGpxList()">ğŸ”„ ë‚´ ì½”ìŠ¤ ëª©ë¡ ìƒˆë¡œê³ ì¹¨</button>
                        <button class="btn btn-success" onclick="downloadAllGPX()">ğŸ“¦ ëª¨ë“  ì½”ìŠ¤ ì¼ê´„ ë‹¤ìš´ë¡œë“œ</button>
                        <span style="margin-left: auto; color: #666;" id="gpxListCount"></span>
                    </div>
                </div>
                <div id="gpxList">
                    <div class="loading">ë‚´ ì½”ìŠ¤ë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘...</div>
                </div>
            </div>
        </div>
    </div>
    
    <script>
        // ì „ì—­ ë³€ìˆ˜
        let currentUser = null;
        let map = null;
        let currentPath = [];
        let currentPolyline = null;
        let markers = [];
        let isDrawMode = true;
        let lastScreen = 'draw';
        
        // ë¡œì»¬ ìŠ¤í† ë¦¬ì§€ í‚¤
        const STORAGE_KEYS = {
            USERS: 'running_app_users',
            COURSES: 'running_app_courses',
            CURRENT_USER: 'running_app_current_user'
        };
        
        // ë¡œì»¬ ìŠ¤í† ë¦¬ì§€ í—¬í¼ í•¨ìˆ˜ë“¤
        function getFromStorage(key) {
            try {
                return JSON.parse(localStorage.getItem(key)) || [];
            } catch {
                return [];
            }
        }
        
        function saveToStorage(key, data) {
            localStorage.setItem(key, JSON.stringify(data));
        }
        
        function generateId() {
            return Date.now() + Math.random().toString(36).substr(2, 9);
        }
        
        // ê±°ë¦¬ ê³„ì‚° í•¨ìˆ˜ (í•˜ë²„ì‚¬ì¸ ê³µì‹)
        function calculateDistance(lat1, lng1, lat2, lng2) {
            const R = 6371e3; // ì§€êµ¬ ë°˜ì§€ë¦„ (ë¯¸í„°)
            const Ï†1 = lat1 * Math.PI/180;
            const Ï†2 = lat2 * Math.PI/180;
            const Î”Ï† = (lat2-lat1) * Math.PI/180;
            const Î”Î» = (lng2-lng1) * Math.PI/180;

            const a = Math.sin(Î”Ï†/2) * Math.sin(Î”Ï†/2) +
                    Math.cos(Ï†1) * Math.cos(Ï†2) *
                    Math.sin(Î”Î»/2) * Math.sin(Î”Î»/2);
            const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a));

            return R * c;
        }
        
        // í™”ë©´ ì „í™˜
        function showScreen(screenName) {
            document.querySelectorAll('.screen').forEach(s => s.classList.remove('active'));
            document.querySelectorAll('.nav-item').forEach(s => s.classList.remove('active'));
            
            document.getElementById(screenName + 'Screen').classList.add('active');
            
            // ë„¤ë¹„ê²Œì´ì…˜ í™œì„±í™”
            const navItems = document.querySelectorAll('.nav-item');
            navItems.forEach((item, index) => {
                const screens = ['draw', 'myCourses', 'search', 'gpxDownload'];
                if (screens[index] === screenName) {
                    item.classList.add('active');
                }
            });
            
            if (screenName === 'draw' && !map) {
                setTimeout(initMap, 100);
            } else if (screenName === 'myCourses') {
                loadMyCourses();
            } else if (screenName === 'search') {
                searchCourses();
            } else if (screenName === 'gpxDownload') {
                loadGpxList();
            }
            
            lastScreen = screenName;
        }
        
        function goBack() {
            showScreen(lastScreen);
        }
        
        // ë¡œê·¸ì¸/íšŒì›ê°€ì… í™”ë©´ ì „í™˜
        function showLogin() {
            document.querySelectorAll('.screen').forEach(s => s.classList.remove('active'));
            document.getElementById('loginScreen').classList.add('active');
        }
        
        function showRegister() {
            document.querySelectorAll('.screen').forEach(s => s.classList.remove('active'));
            document.getElementById('registerScreen').classList.add('active');
        }
        
        // ì•Œë¦¼ í‘œì‹œ
        function showAlert(containerId, message, type = 'success') {
            const container = document.getElementById(containerId);
            container.innerHTML = `<div class="alert alert-${type}">${message}</div>`;
            setTimeout(() => container.innerHTML = '', 5000);
        }
        
        // ë°ëª¨ ê³„ì • ìƒì„±
        function createDemoAccount() {
            const users = getFromStorage(STORAGE_KEYS.USERS);
            const courses = getFromStorage(STORAGE_KEYS.COURSES);
            
            // ë°ëª¨ ì‚¬ìš©ìë“¤ ìƒì„±
            const demoUsers = [
                { id: 'demo1', username: 'runner1', password: '1234', email: 'runner1@example.com', nickname: 'ëŸ¬ë‹ë§ˆìŠ¤í„°', createdAt: new Date().toISOString() },
                { id: 'demo2', username: 'runner2', password: '1234', email: 'runner2@example.com', nickname: 'ì¡°ê¹…ëŸ¬ë²„', createdAt: new Date().toISOString() },
                { id: 'demo3', username: 'runner3', password: '1234', email: 'runner3@example.com', nickname: 'ë§ˆë¼í† ë„ˆ', createdAt: new Date().toISOString() }
            ];
            
            // ê¸°ì¡´ ë°ëª¨ ì‚¬ìš©ì ì œê±° í›„ ì¶”ê°€
            const filteredUsers = users.filter(u => !u.id.startsWith('demo'));
            const newUsers = [...filteredUsers, ...demoUsers];
            saveToStorage(STORAGE_KEYS.USERS, newUsers);
            
            // ë°ëª¨ ì½”ìŠ¤ë“¤ ìƒì„± (ì„œìš¸ ì‹œë‚´ ì‹¤ì œ ëŸ¬ë‹ ì½”ìŠ¤ë“¤)
            const demoCourses = [
                {
                    id: 'course1',
                    userId: 'demo1',
                    name: 'í•œê°•ê³µì› ëŸ¬ë‹ì½”ìŠ¤',
                    description: 'í•œê°•ê³µì› ë°˜í¬ì§€êµ¬ ~ ì ì›ì§€êµ¬ ì™•ë³µ ì½”ìŠ¤ì…ë‹ˆë‹¤. ê°•ë°”ëŒì´ ì‹œì›í•´ìš”!',
                    distance: 5200,
                    difficulty: 2,
                    isPublic: true,
                    centerLat: 37.5169,
                    centerLng: 127.0286,
                    createdAt: new Date(Date.now() - 86400000).toISOString(), // 1ì¼ ì „
                    points: [
                        { lat: 37.5133, lng: 127.0253 },
                        { lat: 37.5156, lng: 127.0275 },
                        { lat: 37.5182, lng: 127.0298 },
                        { lat: 37.5205, lng: 127.0321 },
                        { lat: 37.5182, lng: 127.0298 },
                        { lat: 37.5156, lng: 127.0275 },
                        { lat: 37.5133, lng: 127.0253 }
                    ]
                },
                {
                    id: 'course2',
                    userId: 'demo2',
                    name: 'ë‚¨ì‚°ìˆœí™˜ë¡œ',
                    description: 'ë‚¨ì‚°íƒ€ì›Œ ì£¼ë³€ì„ ë„ëŠ” íë§ ì½”ìŠ¤ì…ë‹ˆë‹¤. ê²½ì‚¬ê°€ ìˆì–´ì„œ ìš´ë™ íš¨ê³¼ ì¢‹ì•„ìš”!',
                    distance: 3800,
                    difficulty: 4,
                    isPublic: true,
                    centerLat: 37.5512,
                    centerLng: 126.9882,
                    createdAt: new Date(Date.now() - 172800000).toISOString(), // 2ì¼ ì „
                    points: [
                        { lat: 37.5505, lng: 126.9909 },
                        { lat: 37.5519, lng: 126.9912 },
                        { lat: 37.5533, lng: 126.9889 },
                        { lat: 37.5521, lng: 126.9855 },
                        { lat: 37.5503, lng: 126.9862 },
                        { lat: 37.5498, lng: 126.9885 },
                        { lat: 37.5505, lng: 126.9909 }
                    ]
                },
                {
                    id: 'course3',
                    userId: 'demo3',
                    name: 'ì˜¬ë¦¼í”½ê³µì› ë²šê½ƒê¸¸',
                    description: 'ì˜¬ë¦¼í”½ê³µì› ë‚´ í‰í™”ì˜ ê´‘ì¥ ì£¼ë³€ ì½”ìŠ¤ì…ë‹ˆë‹¤. ë´„ì—ëŠ” ë²šê½ƒì´ ì˜ˆì˜ê³  í‰ì§€ë¼ í¸í•´ìš”.',
                    distance: 2500,
                    difficulty: 1,
                    isPublic: true,
                    centerLat: 37.5219,
                    centerLng: 127.1217,
                    createdAt: new Date(Date.now() - 259200000).toISOString(), // 3ì¼ ì „
                    points: [
                        { lat: 37.5201, lng: 127.1198 },
                        { lat: 37.5227, lng: 127.1205 },
                        { lat: 37.5239, lng: 127.1231 },
                        { lat: 37.5225, lng: 127.1248 },
                        { lat: 37.5205, lng: 127.1236 },
                        { lat: 37.5201, lng: 127.1198 }
                    ]
                },
                {
                    id: 'course4',
                    userId: 'demo1',
                    name: 'ì²­ê³„ì²œ ëŸ¬ë‹',
                    description: 'ì²­ê³„ì²œ ê´‘êµ ~ ì˜¤ê°„ìˆ˜êµ êµ¬ê°„ì…ë‹ˆë‹¤. ë„ì‹¬ ì† ìì—°ì„ ëŠë‚„ ìˆ˜ ìˆì–´ìš”!',
                    distance: 4100,
                    difficulty: 2,
                    isPublic: true,
                    centerLat: 37.5688,
                    centerLng: 126.9906,
                    createdAt: new Date(Date.now() - 345600000).toISOString(), // 4ì¼ ì „
                    points: [
                        { lat: 37.5701, lng: 126.9849 },
                        { lat: 37.5692, lng: 126.9883 },
                        { lat: 37.5683, lng: 126.9917 },
                        { lat: 37.5674, lng: 126.9951 },
                        { lat: 37.5683, lng: 126.9917 },
                        { lat: 37.5692, lng: 126.9883 },
                        { lat: 37.5701, lng: 126.9849 }
                    ]
                }
            ];
            
            // ê¸°ì¡´ ë°ëª¨ ì½”ìŠ¤ ì œê±° í›„ ì¶”ê°€
            const filteredCourses = courses.filter(c => !c.id.startsWith('course'));
            const newCourses = [...filteredCourses, ...demoCourses];
            saveToStorage(STORAGE_KEYS.COURSES, newCourses);
            
            // ì²« ë²ˆì§¸ ë°ëª¨ ê³„ì •ìœ¼ë¡œ ìë™ ë¡œê·¸ì¸
            currentUser = demoUsers[0];
            saveToStorage(STORAGE_KEYS.CURRENT_USER, currentUser);
            updateUserDisplay();
            showScreen('draw');
            
            showAlert('loginAlert', 'ë°ëª¨ ê³„ì •ì´ ìƒì„±ë˜ê³  ë¡œê·¸ì¸ë˜ì—ˆìŠµë‹ˆë‹¤! (ì•„ì´ë””: runner1, ë¹„ë°€ë²ˆí˜¸: 1234)', 'success');
        }
        
        // ë¡œê·¸ì¸
        document.getElementById('loginForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            
            const username = document.getElementById('loginUsername').value;
            const password = document.getElementById('loginPassword').value;
            
            const users = getFromStorage(STORAGE_KEYS.USERS);
            const user = users.find(u => u.username === username && u.password === password);
            
            if (user) {
                currentUser = user;
                saveToStorage(STORAGE_KEYS.CURRENT_USER, currentUser);
                updateUserDisplay();
                showScreen('draw');
                showAlert('loginAlert', 'ë¡œê·¸ì¸ ì„±ê³µ!', 'success');
            } else {
                showAlert('loginAlert', 'ì˜ëª»ëœ ì‚¬ìš©ìëª… ë˜ëŠ” ë¹„ë°€ë²ˆí˜¸ì…ë‹ˆë‹¤.', 'error');
            }
        });
        
        // íšŒì›ê°€ì…
        document.getElementById('registerForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            
            const username = document.getElementById('regUsername').value;
            const password = document.getElementById('regPassword').value;
            const email = document.getElementById('regEmail').value;
            const nickname = document.getElementById('regNickname').value;
            
            const users = getFromStorage(STORAGE_KEYS.USERS);
            
            // ì¤‘ë³µ ê²€ì‚¬
            if (users.find(u => u.username === username)) {
                showAlert('registerAlert', 'ì´ë¯¸ ì¡´ì¬í•˜ëŠ” ì‚¬ìš©ìëª…ì…ë‹ˆë‹¤.', 'error');
                return;
            }
            
            if (users.find(u => u.email === email)) {
                showAlert('registerAlert', 'ì´ë¯¸ ì¡´ì¬í•˜ëŠ” ì´ë©”ì¼ì…ë‹ˆë‹¤.', 'error');
                return;
            }
            
            // ìƒˆ ì‚¬ìš©ì ìƒì„±
            const newUser = {
                id: generateId(),
                username,
                password,
                email,
                nickname,
                createdAt: new Date().toISOString()
            };
            
            users.push(newUser);
            saveToStorage(STORAGE_KEYS.USERS, users);
            
            showAlert('registerAlert', 'íšŒì›ê°€ì… ì„±ê³µ! ë¡œê·¸ì¸í•´ì£¼ì„¸ìš”.', 'success');
            setTimeout(() => showLogin(), 2000);
        });
        
        // ë¡œê·¸ì•„ì›ƒ
        function logout() {
            currentUser = null;
            localStorage.removeItem(STORAGE_KEYS.CURRENT_USER);
            updateUserDisplay();
            showLogin();
        }
        
        // ì‚¬ìš©ì ì •ë³´ ì—…ë°ì´íŠ¸
        function updateUserDisplay() {
            const userDisplay = document.getElementById('userDisplay');
            const authBtn = document.getElementById('authBtn');
            const navMenu = document.getElementById('navMenu');
            
            if (currentUser) {
                userDisplay.textContent = `${currentUser.nickname}ë‹˜ í™˜ì˜í•©ë‹ˆë‹¤!`;
                authBtn.textContent = 'ë¡œê·¸ì•„ì›ƒ';
                authBtn.className = 'btn btn-danger';
                authBtn.onclick = logout;
                navMenu.style.display = 'block';
            } else {
                userDisplay.textContent = 'ë¡œê·¸ì¸ì´ í•„ìš”í•©ë‹ˆë‹¤';
                authBtn.textContent = 'ë¡œê·¸ì¸';
                authBtn.className = 'btn btn-secondary';
                authBtn.onclick = showLogin;
                navMenu.style.display = 'none';
            }
        }
        
        // ì§€ë„ ì´ˆê¸°í™”
        function initMap() {
            map = new google.maps.Map(document.getElementById("map"), {
                zoom: 15,
                center: { lat: 37.5665, lng: 126.9780 },
                mapTypeId: 'roadmap'
            });
            
            map.addListener("click", onMapClick);
        }
        
        // ì§€ë„ í´ë¦­
        function onMapClick(event) {
            if (!isDrawMode) return;
            
            const point = {
                lat: event.latLng.lat(),
                lng: event.latLng.lng()
            };
            
            currentPath.push(point);
            
            const marker = new google.maps.Marker({
                position: point,
                map: map,
                title: `ì  ${currentPath.length}`,
                label: currentPath.length.toString(),
                animation: google.maps.Animation.DROP
            });
            markers.push(marker);
            
            updatePolyline();
            updateDrawStats();
        }
        
        // ê·¸ë¦¬ê¸° ëª¨ë“œ ì„¤ì •
        function setDrawMode(draw) {
            isDrawMode = draw;
            document.getElementById('drawModeBtn').className = draw ? 'btn btn-primary' : 'btn btn-secondary';
            document.getElementById('viewModeBtn').className = draw ? 'btn btn-secondary' : 'btn btn-primary';
        }
        
        // í´ë¦¬ë¼ì¸ ì—…ë°ì´íŠ¸
        function updatePolyline() {
            if (currentPolyline) {
                currentPolyline.setMap(null);
            }
            
            if (currentPath.length > 1) {
                currentPolyline = new google.maps.Polyline({
                    path: currentPath,
                    geodesic: true,
                    strokeColor: "#FF0000",
                    strokeOpacity: 1.0,
                    strokeWeight: 4,
                });
                currentPolyline.setMap(map);
            }
        }
        
        // í†µê³„ ì—…ë°ì´íŠ¸
        function updateDrawStats() {
            const statsDiv = document.getElementById('drawStats');
            if (currentPath.length === 0) {
                statsDiv.innerHTML = "ì§€ë„ë¥¼ í´ë¦­í•´ì„œ ê²½ë¡œë¥¼ ê·¸ë ¤ë³´ì„¸ìš”! ğŸ—ºï¸";
                return;
            }
            
            let distance = 0;
            for (let i = 1; i < currentPath.length; i++) {
                distance += calculateDistance(
                    currentPath[i-1].lat, currentPath[i-1].lng,
                    currentPath[i].lat, currentPath[i].lng
                );
            }
            
            const pace = 6; // 1kmë‹¹ 6ë¶„
            const estimatedTime = Math.round(distance/1000 * pace);
            const estimatedCalories = Math.round(distance/1000 * 65);
            
            statsDiv.innerHTML = `
                ğŸ“ ì  ê°œìˆ˜: <strong>${currentPath.length}ê°œ</strong> | 
                ğŸ“ ì´ ê±°ë¦¬: <strong>${(distance/1000).toFixed(2)}km</strong> |
                â±ï¸ ì˜ˆìƒ ì‹œê°„: <strong>${estimatedTime}ë¶„</strong> |
                ğŸ”¥ ì˜ˆìƒ ì¹¼ë¡œë¦¬: <strong>${estimatedCalories}kcal</strong>
            `;
        }
        
        // ê²½ë¡œ ì§€ìš°ê¸°
        function clearPath() {
            currentPath = [];
            
            if (currentPolyline) {
                currentPolyline.setMap(null);
                currentPolyline = null;
            }
            
            markers.forEach(marker => marker.setMap(null));
            markers = [];
            
            updateDrawStats();
        }
        
        // ë§ˆì§€ë§‰ ì  ì·¨ì†Œ
        function undoLastPoint() {
            if (currentPath.length === 0) return;
            
            currentPath.pop();
            
            const lastMarker = markers.pop();
            if (lastMarker) {
                lastMarker.setMap(null);
            }
            
            updatePolyline();
            updateDrawStats();
        }
        
        // í˜„ì¬ ìœ„ì¹˜
        function getCurrentLocation() {
            if (navigator.geolocation) {
                navigator.geolocation.getCurrentPosition(function(position) {
                    const pos = {
                        lat: position.coords.latitude,
                        lng: position.coords.longitude
                    };
                    
                    map.setCenter(pos);
                    map.setZoom(16);
                    
                    // í˜„ì¬ ìœ„ì¹˜ ë§ˆì»¤
                    new google.maps.Marker({
                        position: pos,
                        map: map,
                        title: 'í˜„ì¬ ìœ„ì¹˜',
                        icon: {
                            path: google.maps.SymbolPath.CIRCLE,
                            scale: 8,
                            fillColor: '#4285f4',
                            fillOpacity: 1,
                            strokeColor: '#ffffff',
                            strokeWeight: 2,
                        }
                    });
                });
            } else {
                alert('GPSë¥¼ ì§€ì›í•˜ì§€ ì•ŠëŠ” ë¸Œë¼ìš°ì €ì…ë‹ˆë‹¤.');
            }
        }
        
        // ì½”ìŠ¤ ì €ì¥
        function saveCourse() {
            if (!currentUser) {
                alert('ë¡œê·¸ì¸ì´ í•„ìš”í•©ë‹ˆë‹¤.');
                return;
            }
            
            const name = document.getElementById('courseName').value.trim();
            const description = document.getElementById('courseDescription').value.trim();
            const difficulty = parseInt(document.getElementById('courseDifficulty').value);
            const isPublic = document.getElementById('coursePublic').checked;
            
            if (!name) {
                alert('ì½”ìŠ¤ ì´ë¦„ì„ ì…ë ¥í•´ì£¼ì„¸ìš”.');
                return;
            }
            
            if (currentPath.length < 2) {
                alert('ìµœì†Œ 2ê°œ ì´ìƒì˜ ì ì´ í•„ìš”í•©ë‹ˆë‹¤.');
                return;
            }
            
            // ê±°ë¦¬ ê³„ì‚°
            let distance = 0;
            for (let i = 1; i < currentPath.length; i++) {
                distance += calculateDistance(
                    currentPath[i-1].lat, currentPath[i-1].lng,
                    currentPath[i].lat, currentPath[i].lng
                );
            }
            
            // ì¤‘ì‹¬ì  ê³„ì‚°
            const avgLat = currentPath.reduce((sum, p) => sum + p.lat, 0) / currentPath.length;
            const avgLng = currentPath.reduce((sum, p) => sum + p.lng, 0) / currentPath.length;
            
            const newCourse = {
                id: generateId(),
                userId: currentUser.id,
                name,
                description,
                distance,
                difficulty,
                isPublic,
                centerLat: avgLat,
                centerLng: avgLng,
                createdAt: new Date().toISOString(),
                points: currentPath.map(p => ({ lat: p.lat, lng: p.lng }))
            };
            
            const courses = getFromStorage(STORAGE_KEYS.COURSES);
            courses.push(newCourse);
            saveToStorage(STORAGE_KEYS.COURSES, courses);
            
            alert(`"${name}" ì½”ìŠ¤ê°€ ì €ì¥ë˜ì—ˆìŠµë‹ˆë‹¤!`);
            
            // í¼ ì´ˆê¸°í™”
            document.getElementById('courseName').value = '';
            document.getElementById('courseDescription').value = '';
            clearPath();
        }
        
        // ë‚´ ì½”ìŠ¤ ëª©ë¡ ë¡œë“œ
        function loadMyCourses() {
            if (!currentUser) return;
            
            const sortBy = document.getElementById('mySortBy').value;
            const container = document.getElementById('myCoursesContent');
            const countElement = document.getElementById('myCoursesCount');
            
            container.innerHTML = '<div class="loading">ë‚´ ì½”ìŠ¤ë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘...</div>';
            
            const courses = getFromStorage(STORAGE_KEYS.COURSES);
            const myCourses = courses.filter(c => c.userId === currentUser.id);
            
            // ì •ë ¬
            myCourses.sort((a, b) => {
                switch (sortBy) {
                    case 'distance':
                        return a.distance - b.distance;
                    case 'difficulty':
                        return a.difficulty - b.difficulty;
                    case 'name':
                        return a.name.localeCompare(b.name);
                    default: // date
                        return new Date(b.createdAt) - new Date(a.createdAt);
                }
            });
            
            countElement.textContent = `ì´ ${myCourses.length}ê°œ ì½”ìŠ¤`;
            
            if (myCourses.length === 0) {
                container.innerHTML = '<p style="text-align: center; color: #666; padding: 40px;">ì €ì¥ëœ ì½”ìŠ¤ê°€ ì—†ìŠµë‹ˆë‹¤. ì½”ìŠ¤ë¥¼ ë§Œë“¤ì–´ë³´ì„¸ìš”!</p>';
                return;
            }
            
            const difficultyNames = ['', 'ì‰¬ì›€', 'ë³´í†µ', 'ì¤‘ê°„', 'ì–´ë ¤ì›€', 'ë§¤ìš° ì–´ë ¤ì›€'];
            
            container.innerHTML = `<div class="course-list">${myCourses.map(course => `
                <div class="course-item">
                    <div class="course-header">
                        <div class="course-title">${course.name}</div>
                        <div class="difficulty-badge difficulty-${course.difficulty}">
                            ${difficultyNames[course.difficulty]}
                        </div>
                    </div>
                    <div class="course-info">
                        ğŸ“ ${(course.distance/1000).toFixed(2)}km | 
                        ğŸ“… ${new Date(course.createdAt).toLocaleDateString()} |
                        ğŸ“ ${course.points.length}ê°œ ì  |
                        ${course.isPublic ? 'ğŸŒ ê³µê°œ' : 'ğŸ”’ ë¹„ê³µê°œ'}
                    </div>
                    <p style="margin: 10px 0; color: #666;">${course.description || 'ì„¤ëª… ì—†ìŒ'}</p>
                    <div class="course-actions">
                        <button class="btn btn-primary" onclick="viewCourse('${course.id}')">ğŸ—ºï¸ ì§€ë„ì—ì„œ ë³´ê¸°</button>
                        <button class="btn btn-success" onclick="downloadGPX('${course.id}')">ğŸ“ GPX ë‹¤ìš´ë¡œë“œ</button>
                        <button class="btn btn-secondary" onclick="editCourse('${course.id}')">âœï¸ ìˆ˜ì •</button>
                        <button class="btn btn-danger" onclick="deleteCourse('${course.id}')">ğŸ—‘ï¸ ì‚­ì œ</button>
                    </div>
                </div>
            `).join('')}</div>`;
        }
        
        // ê³µê°œ ì½”ìŠ¤ ê²€ìƒ‰
        function searchCourses() {
            const container = document.getElementById('searchResults');
            const countElement = document.getElementById('searchResultsCount');
            
            container.innerHTML = '<div class="loading">ì½”ìŠ¤ë¥¼ ê²€ìƒ‰í•˜ëŠ” ì¤‘...</div>';
            
            const difficulty = document.getElementById('searchDifficulty').value;
            const minDistance = parseFloat(document.getElementById('searchMinDistance').value) || 0;
            const maxDistance = parseFloat(document.getElementById('searchMaxDistance').value) || Infinity;
            
            const courses = getFromStorage(STORAGE_KEYS.COURSES);
            const users = getFromStorage(STORAGE_KEYS.USERS);
            
            let results = courses.filter(course => {
                if (!course.isPublic) return false;
                if (difficulty && course.difficulty !== parseInt(difficulty)) return false;
                
                const distanceKm = course.distance / 1000;
                if (distanceKm < minDistance || distanceKm > maxDistance) return false;
                
                return true;
            });
            
            // ì‚¬ìš©ì ì •ë³´ ì¶”ê°€
            results = results.map(course => {
                const user = users.find(u => u.id === course.userId);
                return { ...course, user };
            });
            
            // ìµœì‹ ìˆœ ì •ë ¬
            results.sort((a, b) => new Date(b.createdAt) - new Date(a.createdAt));
            
            countElement.textContent = `${results.length}ê°œ ì½”ìŠ¤ ë°œê²¬`;
            
            if (results.length === 0) {
                container.innerHTML = '<p style="text-align: center; color: #666; padding: 40px;">ê²€ìƒ‰ ì¡°ê±´ì— ë§ëŠ” ì½”ìŠ¤ê°€ ì—†ìŠµë‹ˆë‹¤.</p>';
                return;
            }
            
            const difficultyNames = ['', 'ì‰¬ì›€', 'ë³´í†µ', 'ì¤‘ê°„', 'ì–´ë ¤ì›€', 'ë§¤ìš° ì–´ë ¤ì›€'];
            
            container.innerHTML = `<div class="course-list">${results.map(course => `
                <div class="course-item">
                    <div class="course-header">
                        <div class="course-title">${course.name}</div>
                        <div class="difficulty-badge difficulty-${course.difficulty}">
                            ${difficultyNames[course.difficulty]}
                        </div>
                    </div>
                    <div class="course-info">
                        ğŸ“ ${(course.distance/1000).toFixed(2)}km | 
                        ğŸ“… ${new Date(course.createdAt).toLocaleDateString()} |
                        ğŸ‘¤ ${course.user?.nickname || 'ìµëª…'}
                    </div>
                    <p style="margin: 10px 0; color: #666;">${course.description || 'ì„¤ëª… ì—†ìŒ'}</p>
                    <div class="course-actions">
                        <button class="btn btn-primary" onclick="viewCourse('${course.id}')">ğŸ—ºï¸ ì§€ë„ì—ì„œ ë³´ê¸°</button>
                        <button class="btn btn-success" onclick="downloadGPX('${course.id}')">ğŸ“ GPX ë‹¤ìš´ë¡œë“œ</button>
                    </div>
                </div>
            `).join('')}</div>`;
        }
        
        // ìœ„ì¹˜ ê¸°ë°˜ ê²€ìƒ‰
        function searchNearby() {
            if (!navigator.geolocation) {
                alert('GPSë¥¼ ì§€ì›í•˜ì§€ ì•ŠëŠ” ë¸Œë¼ìš°ì €ì…ë‹ˆë‹¤.');
                return;
            }
            
            navigator.geolocation.getCurrentPosition(function(position) {
                const myLat = position.coords.latitude;
                const myLng = position.coords.longitude;
                const radiusKm = parseFloat(document.getElementById('searchRadius').value) || 10;
                
                const container = document.getElementById('searchResults');
                const countElement = document.getElementById('searchResultsCount');
                
                container.innerHTML = '<div class="loading">ê·¼ì²˜ ì½”ìŠ¤ë¥¼ ê²€ìƒ‰í•˜ëŠ” ì¤‘...</div>';
                
                const courses = getFromStorage(STORAGE_KEYS.COURSES);
                const users = getFromStorage(STORAGE_KEYS.USERS);
                
                // ê±°ë¦¬ ê³„ì‚° ë° í•„í„°ë§
                let results = courses
                    .filter(course => course.isPublic)
                    .map(course => {
                        const distance = calculateDistance(myLat, myLng, course.centerLat, course.centerLng) / 1000; // km
                        const user = users.find(u => u.id === course.userId);
                        return { ...course, distanceFromMe: distance, user };
                    })
                    .filter(course => course.distanceFromMe <= radiusKm)
                    .sort((a, b) => a.distanceFromMe - b.distanceFromMe);
                
                countElement.textContent = `ë°˜ê²½ ${radiusKm}km ë‚´ ${results.length}ê°œ ì½”ìŠ¤`;
                
                if (results.length === 0) {
                    container.innerHTML = '<p style="text-align: center; color: #666; padding: 40px;">ê·¼ì²˜ì— ê³µê°œëœ ì½”ìŠ¤ê°€ ì—†ìŠµë‹ˆë‹¤.</p>';
                    return;
                }
                
                const difficultyNames = ['', 'ì‰¬ì›€', 'ë³´í†µ', 'ì¤‘ê°„', 'ì–´ë ¤ì›€', 'ë§¤ìš° ì–´ë ¤ì›€'];
                
                container.innerHTML = `<div class="course-list">${results.map(course => `
                    <div class="course-item">
                        <div class="course-header">
                            <div class="course-title">${course.name}</div>
                            <div class="difficulty-badge difficulty-${course.difficulty}">
                                ${difficultyNames[course.difficulty]}
                            </div>
                        </div>
                        <div class="course-info">
                            ğŸ“ ${(course.distance/1000).toFixed(2)}km | 
                            ğŸ“ ê±°ë¦¬: ${course.distanceFromMe.toFixed(1)}km |
                            ğŸ‘¤ ${course.user?.nickname || 'ìµëª…'}
                        </div>
                        <p style="margin: 10px 0; color: #666;">${course.description || 'ì„¤ëª… ì—†ìŒ'}</p>
                        <div class="course-actions">
                            <button class="btn btn-primary" onclick="viewCourse('${course.id}')">ğŸ—ºï¸ ì§€ë„ì—ì„œ ë³´ê¸°</button>
                            <button class="btn btn-success" onclick="downloadGPX('${course.id}')">ğŸ“ GPX ë‹¤ìš´ë¡œë“œ</button>
                        </div>
                    </div>
                `).join('')}</div>`;
            });
        }
        
        // ì½”ìŠ¤ ìƒì„¸ ë³´ê¸°
        function viewCourse(courseId) {
            const courses = getFromStorage(STORAGE_KEYS.COURSES);
            const users = getFromStorage(STORAGE_KEYS.USERS);
            const course = courses.find(c => c.id === courseId);
            
            if (!course) {
                alert('ì½”ìŠ¤ë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.');
                return;
            }
            
            const user = users.find(u => u.id === course.userId);
            const difficultyNames = ['', 'ì‰¬ì›€', 'ë³´í†µ', 'ì¤‘ê°„', 'ì–´ë ¤ì›€', 'ë§¤ìš° ì–´ë ¤ì›€'];
            
            document.getElementById('detailTitle').textContent = course.name;
            document.getElementById('detailInfo').innerHTML = `
                <div style="background: #f8f9fa; padding: 20px; border-radius: 8px; margin-bottom: 15px;">
                    <h4 style="margin-bottom: 15px; color: #333;">${course.name}</h4>
                    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 15px; margin-bottom: 15px;">
                        <div><strong>ê±°ë¦¬:</strong> ${(course.distance/1000).toFixed(2)}km</div>
                        <div><strong>ë‚œì´ë„:</strong> ${difficultyNames[course.difficulty]}</div>
                        <div><strong>ì  ê°œìˆ˜:</strong> ${course.points.length}ê°œ</div>
                        <div><strong>ìƒì„±ì:</strong> ${user?.nickname || 'ìµëª…'}</div>
                        <div><strong>ìƒì„±ì¼:</strong> ${new Date(course.createdAt).toLocaleDateString()}</div>
                        <div><strong>ê³µê°œ:</strong> ${course.isPublic ? 'ê³µê°œ' : 'ë¹„ê³µê°œ'}</div>
                    </div>
                    <div><strong>ì„¤ëª…:</strong> ${course.description || 'ì„¤ëª… ì—†ìŒ'}</div>
                    <div style="margin-top: 15px;">
                        <button class="btn btn-success" onclick="downloadGPX('${course.id}')">ğŸ“ GPX ë‹¤ìš´ë¡œë“œ</button>
                        ${course.userId === currentUser?.id ? `<button class="btn btn-secondary" onclick="editCourse('${course.id}')">âœï¸ ìˆ˜ì •</button>` : ''}
                    </div>
                </div>
            `;
            
            showScreen('detail');
            
            // ìƒì„¸ ì§€ë„ ì´ˆê¸°í™”
            setTimeout(() => {
                const detailMap = new google.maps.Map(document.getElementById("detailMap"), {
                    zoom: 15,
                    center: { lat: course.centerLat, lng: course.centerLng },
                    mapTypeId: 'roadmap'
                });
                
                // í¬ì¸íŠ¸ë“¤ í‘œì‹œ
                course.points.forEach((point, index) => {
                    new google.maps.Marker({
                        position: { lat: point.lat, lng: point.lng },
                        map: detailMap,
                        title: `ì  ${index + 1}`,
                        label: (index + 1).toString()
                    });
                });
                
                // í´ë¦¬ë¼ì¸ ê·¸ë¦¬ê¸°
                const polyline = new google.maps.Polyline({
                    path: course.points.map(p => ({ lat: p.lat, lng: p.lng })),
                    geodesic: true,
                    strokeColor: "#FF0000",
                    strokeOpacity: 1.0,
                    strokeWeight: 4,
                });
                polyline.setMap(detailMap);
                
                // ì§€ë„ ì˜ì—­ ì¡°ì •
                const bounds = new google.maps.LatLngBounds();
                course.points.forEach(point => bounds.extend({ lat: point.lat, lng: point.lng }));
                detailMap.fitBounds(bounds);
            }, 100);
        }
        
        // GPX ë‹¤ìš´ë¡œë“œ
        function downloadGPX(courseId) {
            const courses = getFromStorage(STORAGE_KEYS.COURSES);
            const course = courses.find(c => c.id === courseId);
            
            if (!course) {
                alert('ì½”ìŠ¤ë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.');
                return;
            }
            
            const now = new Date();
            let gpxContent = `<?xml version="1.0" encoding="UTF-8"?>
<gpx version="1.1" creator="RunningApp" xmlns="http://www.topografix.com/GPX/1/1">
    <metadata>
        <name>${course.name}</name>
        <desc>${course.description || ''}</desc>
        <time>${course.createdAt}</time>
    </metadata>
    <trk>
        <name>${course.name}</name>
        <desc>${course.description || ''}</desc>
        <trkseg>`;
            
            course.points.forEach((point, index) => {
                const time = new Date(now.getTime() + index * 30000); // 30ì´ˆ ê°„ê²©
                gpxContent += `
            <trkpt lat="${point.lat}" lon="${point.lng}">
                <time>${time.toISOString()}</time>
            </trkpt>`;
            });
            
            gpxContent += `
        </trkseg>
    </trk>
</gpx>`;
            
            // íŒŒì¼ ë‹¤ìš´ë¡œë“œ
            const blob = new Blob([gpxContent], { type: 'application/gpx+xml' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `${course.name.replace(/[^a-z0-9ê°€-í£\s]/gi, '_')}.gpx`;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
            
            alert(`${course.name}.gpx íŒŒì¼ì´ ë‹¤ìš´ë¡œë“œë˜ì—ˆìŠµë‹ˆë‹¤!`);
        }
        
        // ëª¨ë“  ì½”ìŠ¤ GPX ì¼ê´„ ë‹¤ìš´ë¡œë“œ
        function downloadAllGPX() {
            if (!currentUser) return;
            
            const courses = getFromStorage(STORAGE_KEYS.COURSES);
            const myCourses = courses.filter(c => c.userId === currentUser.id);
            
            if (myCourses.length === 0) {
                alert('ë‹¤ìš´ë¡œë“œí•  ì½”ìŠ¤ê°€ ì—†ìŠµë‹ˆë‹¤.');
                return;
            }
            
            if (!confirm(`ì´ ${myCourses.length}ê°œ ì½”ìŠ¤ë¥¼ ë‹¤ìš´ë¡œë“œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?`)) {
                return;
            }
            
            myCourses.forEach((course, index) => {
                setTimeout(() => downloadGPX(course.id), index * 500); // 0.5ì´ˆ ê°„ê²©
            });
        }
        
        // ì½”ìŠ¤ ìˆ˜ì •
        function editCourse(courseId) {
            const courses = getFromStorage(STORAGE_KEYS.COURSES);
            const course = courses.find(c => c.id === courseId);
            
            if (!course || course.userId !== currentUser?.id) {
                alert('ìˆ˜ì • ê¶Œí•œì´ ì—†ìŠµë‹ˆë‹¤.');
                return;
            }
            
            // ê°„ë‹¨í•œ ìˆ˜ì • (ì´ë¦„, ì„¤ëª…, ë‚œì´ë„, ê³µê°œì—¬ë¶€ë§Œ)
            const newName = prompt('ì½”ìŠ¤ ì´ë¦„:', course.name);
            if (newName === null) return;
            
            const newDescription = prompt('ì½”ìŠ¤ ì„¤ëª…:', course.description || '');
            if (newDescription === null) return;
            
            const newDifficulty = prompt('ë‚œì´ë„ (1-5):', course.difficulty);
            if (newDifficulty === null) return;
            
            const newIsPublic = confirm('ê³µê°œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?');
            
            // ìœ íš¨ì„± ê²€ì‚¬
            if (!newName.trim()) {
                alert('ì½”ìŠ¤ ì´ë¦„ì€ í•„ìˆ˜ì…ë‹ˆë‹¤.');
                return;
            }
            
            const difficulty = parseInt(newDifficulty);
            if (isNaN(difficulty) || difficulty < 1 || difficulty > 5) {
                alert('ë‚œì´ë„ëŠ” 1-5 ì‚¬ì´ì˜ ìˆ«ìì—¬ì•¼ í•©ë‹ˆë‹¤.');
                return;
            }
            
            // ìˆ˜ì • ì ìš©
            const courseIndex = courses.findIndex(c => c.id === courseId);
            courses[courseIndex] = {
                ...course,
                name: newName.trim(),
                description: newDescription.trim(),
                difficulty,
                isPublic: newIsPublic
            };
            
            saveToStorage(STORAGE_KEYS.COURSES, courses);
            alert('ì½”ìŠ¤ê°€ ìˆ˜ì •ë˜ì—ˆìŠµë‹ˆë‹¤.');
            
            // í˜„ì¬ í™”ë©´ ìƒˆë¡œê³ ì¹¨
            if (lastScreen === 'myCourses') {
                loadMyCourses();
            }
        }
        
        // ì½”ìŠ¤ ì‚­ì œ
        function deleteCourse(courseId) {
            if (!confirm('ì •ë§ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ? ì´ ì‘ì—…ì€ ë˜ëŒë¦´ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.')) return;
            
            const courses = getFromStorage(STORAGE_KEYS.COURSES);
            const filteredCourses = courses.filter(c => c.id !== courseId);
            saveToStorage(STORAGE_KEYS.COURSES, filteredCourses);
            
            alert('ì½”ìŠ¤ê°€ ì‚­ì œë˜ì—ˆìŠµë‹ˆë‹¤.');
            loadMyCourses();
        }
        
        // GPX ëª©ë¡ ë¡œë“œ
        function loadGpxList() {
            if (!currentUser) return;
            
            const container = document.getElementById('gpxList');
            const countElement = document.getElementById('gpxListCount');
            
            container.innerHTML = '<div class="loading">ë‚´ ì½”ìŠ¤ë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘...</div>';
            
            const courses = getFromStorage(STORAGE_KEYS.COURSES);
            const myCourses = courses
                .filter(c => c.userId === currentUser.id)
                .sort((a, b) => new Date(b.createdAt) - new Date(a.createdAt));
            
            countElement.textContent = `ì´ ${myCourses.length}ê°œ ì½”ìŠ¤`;
            
            if (myCourses.length === 0) {
                container.innerHTML = '<p style="text-align: center; color: #666; padding: 40px;">ì €ì¥ëœ ì½”ìŠ¤ê°€ ì—†ìŠµë‹ˆë‹¤.</p>';
                return;
            }
            
            const difficultyNames = ['', 'ì‰¬ì›€', 'ë³´í†µ', 'ì¤‘ê°„', 'ì–´ë ¤ì›€', 'ë§¤ìš° ì–´ë ¤ì›€'];
            
            container.innerHTML = `<div class="course-list">${myCourses.map(course => `
                <div class="course-item">
                    <div class="course-header">
                        <div class="course-title">${course.name}</div>
                        <div class="difficulty-badge difficulty-${course.difficulty}">
                            ${difficultyNames[course.difficulty]}
                        </div>
                    </div>
                    <div class="course-info">
                        ğŸ“ ${(course.distance/1000).toFixed(2)}km | 
                        ğŸ“… ${new Date(course.createdAt).toLocaleDateString()} |
                        ğŸ“ ${course.points.length}ê°œ ì 
                    </div>
                    <p style="margin: 10px 0; color: #666;">${course.description || 'ì„¤ëª… ì—†ìŒ'}</p>
                    <div class="course-actions">
                        <button class="btn btn-success" onclick="downloadGPX('${course.id}')">ğŸ“ GPX ë‹¤ìš´ë¡œë“œ</button>
                        <button class="btn btn-primary" onclick="viewCourse('${course.id}')">ğŸ—ºï¸ ì§€ë„ì—ì„œ ë³´ê¸°</button>
                    </div>
                </div>
            `).join('')}</div>`;
        }
        
        // í˜ì´ì§€ ë¡œë“œ ì‹œ ì´ˆê¸°í™”
        window.onload = function() {
            // ì €ì¥ëœ ì‚¬ìš©ì ì •ë³´ ë³µì›
            const savedUser = getFromStorage(STORAGE_KEYS.CURRENT_USER);
            if (savedUser && typeof savedUser === 'object' && savedUser.id) {
                currentUser = savedUser;
            }
            
            updateUserDisplay();
            
            // ë¡œê·¸ì¸ëœ ê²½ìš° ìë™ìœ¼ë¡œ ê·¸ë¦¬ê¸° í™”ë©´ìœ¼ë¡œ
            if (currentUser) {
                showScreen('draw');
            }
        };
    </script>
    
    <!-- êµ¬ê¸€ë§µ API ë¡œë“œ -->
    <script async defer
        src="https://maps.googleapis.com/maps/api/js?key=YOUR_API_KEY&libraries=geometry&callback=initMap">
    </script>
</body>
</html>